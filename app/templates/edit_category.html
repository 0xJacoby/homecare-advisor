<!doctype html>
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Redigera befintliga kategorier</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #f6f6f6;
        padding: 20px;
      }

      h1 {
        margin-bottom: 20px;
      }

      .back-link {
        display: inline-block;
        margin-bottom: 20px;
        padding: 8px 14px;
        border-radius: 8px;
        border: 1px solid #000;
        background: #fff;
        cursor: pointer;
        text-decoration: none;
        color: #000;
      }

      .config-container {
        background: #fff;
        border: 2px solid #000;
        border-radius: 10px;
        padding: 20px;
        max-width: 900px;
      }

      .section-title {
        font-weight: bold;
        margin-top: 10px;
        margin-bottom: 10px;
        font-size: 18px;
      }

      .row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        flex-wrap: wrap;
      }

      label {
        font-weight: bold;
        display: block;
        margin-bottom: 4px;
      }

      input[type="text"],
      select {
        padding: 6px;
        border-radius: 6px;
        border: 1px solid #aaa;
      }

      input[type="text"] {
        min-width: 240px;
        flex: 1;
      }

      select {
        min-width: 240px;
      }

      button {
        padding: 6px 12px;
        border-radius: 8px;
        border: 2px solid #000;
        background: #fff;
        cursor: pointer;
        font-weight: bold;
      }

      button.small {
        padding: 4px 8px;
        font-size: 12px;
      }

      button.danger {
        border-color: #b00020;
        color: #b00020;
      }

      button:hover {
        opacity: 0.9;
      }

      .param-list {
        margin-top: 10px;
        border-top: 1px solid #ddd;
        padding-top: 10px;
      }

      .param-row {
        display: grid;
        grid-template-columns: 1.5fr 1.5fr 0.7fr; /* 3 kolumner: namn, vikt, ta bort */
        gap: 8px;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px solid #eee;
      }

      .param-name-label {
        padding: 4px 0;
      }

      .slider-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .slider-wrapper input[type="range"] {
        flex: 1;
      }

      .slider-value {
        min-width: 24px;
        text-align: right;
        font-weight: bold;
      }

      .empty-text {
        font-style: italic;
        color: #666;
        padding: 6px 0;
      }
            .help-box {
        position: fixed;
        right: 0;
        top: 0;
        width: 400px;
        height: 60%;
        background: white;
        border: 2px solid black;
        border-radius: 10px;
        padding: 20px;
        margin: 14px;
        margin-top: 5%;
        overflow-y: auto;
        transform: translateX(100%);
        transition: 0.3s ease;
        z-index: 2000;
      }

      .help-box.show {
        transform: translateX(0);
      }

      .help-box .close-btn {
        float: right;
        cursor: pointer;
        font-weight: bold;
        font-size: 20px;
      }

      .help-btn {
        margin-left: 10px;
        background: #ddd;
        border-radius: 50%;
        width: 22px;
        height: 22px;
        display: inline-flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        border: 1px solid black;
        font-weight: bold;
      }

    </style>
  </head>
  <body>
    <!-- Back to main page -->
    <a href="/" class="back-link">← Tillbaka</a>

    <h1>Redigera befintliga kategorier</h1>

    <div class="config-container">
      <!-- ========== CATEGORY SECTION ========== -->
      <div class="section-title">1. Välj diagnoskategori</div>

      <div class="row">
        <div>
          <label for="categorySelect">Befintlig kategori:</label>
          <select id="categorySelect">
            <!-- Fylls med JS -->
          </select>
        </div>

        <div style="align-self: flex-end">
          <button id="deleteCategoryBtn" class="danger">
            Ta bort kategori
          </button>
        </div>
      </div>

      <!-- ========== PARAMETER SECTION ========== -->
      <div class="section-title">
        2. Parametrar och vikter för vald kategori
      </div>

      <!-- Add new parameter -->
      <div class="row">
        <div style="flex: 2">
          <label for="newParamSelect">Ny parameter:</label>
          <select id="newParamSelect">
            <option value="">– Välj parameter –</option>
            <option value="Hemsituation">Hemsituation</option>
            <option value="Blodtryck">Blodtryck</option>
            <option value="Puls">Puls</option>
            <option value="Andningsfrekvens">Andningsfrekvens</option>
            <option value="Syremättnad">Syremättnad</option>
            <option value="Hemoglobin (Hb)">Hemoglobin (Hb)</option>
            <option value="CRP (C-reaktiv protein)">CRP (C-reaktiv protein)</option>
            <option value="Kroppstemperatur">Kroppstemperatur</option>
            <option value="Krea">Kreatinin</option>
            <option value="eGFR">eGFR</option>
            <option value="Glukos">Glukos</option>
            <option value="LPK">LPK</option>
            <option value="NEWS">NEWS</option>
            <option value="Kalium">Kalium</option>
            <option value="TPK">TPK</option>
            <option value="Natrium">Natrium</option>
            <option value="Önskar stanna">Önskar stanna</option>
          </select>
        </div>

        <div style="flex: 1">
          <label for="newParamWeight"
            >Vikt (0 = inte relevant, 10 = mycket viktig):</label
          >
          <div class="slider-wrapper">
            <input
              type="range"
              id="newParamWeight"
              min="0"
              max="10"
              value="5"
            />
            <span class="slider-value" id="newParamWeightLabel">5</span>
          </div>
        </div>

        <div style="align-self: flex-end">
          <button id="addParamBtn">Lägg till parameter</button>
        </div>
      </div>

      <!-- List of parameters for selected category -->
      <div class="param-list" id="paramList">
        <!-- Fylls med JS -->
      </div>
    </div>

    <script>
      // ==============================
      //  API CONFIG
      // ==============================
      const API_URL = "/api/categories/";

      // DOM elements
      const categorySelect = document.getElementById("categorySelect");
      const deleteCategoryBtn = document.getElementById("deleteCategoryBtn");
      const paramList = document.getElementById("paramList");
      const newParamSelect = document.getElementById("newParamSelect");
      const newParamWeight = document.getElementById("newParamWeight");
      const newParamWeightLabel = document.getElementById(
        "newParamWeightLabel",
      );
      const addParamBtn = document.getElementById("addParamBtn");

      // ==============================
      //  API HELPERS
      // ==============================

      // GET all categories from backend
      async function loadCategoriesFromAPI() {
        try {
          const res = await fetch(API_URL, { method: "GET" });
          if (!res.ok) {
            console.error("Could not load categories:", res.status);
            return [];
          }
          const data = await res.json();

          // Expecting: [{ name, parameters: [{name, weight, ...}, ...] }, ...]
          return (data || []).map((cat) => ({
            id: cat.name, // use name as id
            name: cat.name,
            parameters: (cat.parameters || []).map((p) => ({
              id: p.name,
              name: p.name,
              weight: Number(p.weight ?? 0) * 5, // Från 0-2 till 0-10
            })),
          }));
        } catch (err) {
          console.error("Could not load categories:", err);
          return [];
        }
      }

      // PATCH one category in backend
      async function saveCategoryToAPI(category) {
        try {
          const payload = {
            name: category.name,
            parameters: category.parameters.map((p) => ({
              name: p.name,
              weight: p.weight / 5, //Från 0-10 till 0-2
            })),
          };

          const res = await fetch(API_URL, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            console.error(
              "Could not save category:",
              res.status,
              await res.text(),
            );
          }
        } catch (err) {
          console.error("Could not save category:", err);
        }
      }

      // DELETE category by name
      async function deleteCategoryFromAPI(name) {
        try {
          const url = API_URL + "?name=" + encodeURIComponent(name);
          const res = await fetch(url, { method: "DELETE" });
          if (!res.ok) {
            console.error(
              "Could not delete category:",
              res.status,
              await res.text(),
            );
          }
        } catch (err) {
          console.error("Could not delete category:", err);
        }
      }

      // ==============================
      //  STATE
      // ==============================
      let categories = [];
      let currentCategoryId = null; // "natural mode": ingenting valt

      // ==============================
      //  UI RENDERING
      // ==============================

      function renderCategorySelect() {
        categorySelect.innerHTML = "";

        // Placeholder "natural mode"
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "– Välj kategori –";
        categorySelect.appendChild(placeholder);

        // Add all categories
        categories.forEach((cat) => {
          const opt = document.createElement("option");
          opt.value = cat.id;
          opt.textContent = cat.name;
          categorySelect.appendChild(opt);
        });

        // Keep selection if still valid
        if (
          currentCategoryId &&
          categories.find((c) => c.id === currentCategoryId)
        ) {
          categorySelect.value = currentCategoryId;
        } else {
          currentCategoryId = null;
          categorySelect.value = "";
        }

        renderParamList();
      }
      
      /////////////// LÄGG TILL PARAMETER BESKRIVNINGAR HÄR ///////////////////////
      const hemSituationInfo = 
          "Poängen börjar på 10. Om hemtjänst finns sätts poängen direkt till 100. "+
          "Om hemtjänst inte finns beräknas poängen som medelvärdet av alla parametrar "+
          "och ges ett slutvärde mellan 0 och 100."

      const BlodtryckDescription =
        "Blodtryck bedöms enligt följande intervall:<br><br>" +
        "• &lt;120 / &lt;80 → Poäng: 100 (normalt blodtryck)<br>" +
        "• 120–129 / &lt;80 → Poäng: 90 (förhöjt men ej akut)<br>" +
        "• 130–139 / 80–89 → Poäng: 70 (lindrig hypertoni)<br>" +
        "• 140–179 / 90–119 → Poäng: 50 (måttlig hypertoni)<br>" +
        "• ≥180 / ≥120 → Poäng: 10 (kraftigt avvikande, hög risk)<br><br>" +
        "Högre poäng innebär stabilare blodtryck och mindre risk.<br>" +
        "Lägre poäng innebär högre risk och större behov av medicinsk bedömning.";

        const temperaturInfo =
        "Temperatur bedöms enligt följande:<br><br>" +
        "• 36.0–37.8°C → Poäng: 100 (normal kroppstemperatur)<br>" +
        "• Utanför intervallet → Poäng: 0 (avvikande temperatur)<br><br>" +
        "Ett normalt temperaturintervall ger högsta poäng och indikerar stabilt tillstånd.<br>" +
        "Avvikande temperatur kan signalera infektion eller annan påverkan och ger därför lägre poäng.";

        const crpInfo = "Räknas ut genom att jämföra föregånde CRP med nuvarande CRP. Om nuvarande CRP är mer än 10 mindre än föregående indikerar detta möjlig hemvård"; 

        const newsInfo = "NEWS beräknas genom att varje vitalparameter får 0–3 poäng, poängen summeras, och slutresultatet blir ett värde mellan 0–100 baserat på både totalpoängen och om någon parameter fått en 3:a."; 

        const spoInfo = "Syremättnaden beräknas genom att jämföra aktuell saturation med ett målvärde (ger 100 om nästan identiskt, annars 0) eller, om inget mål finns, normaliseras värdet linjärt mellan 89–100 %.";

        const kaliumInfo = "Kaliumvärdet omvandlas till poäng mellan 0–100 genom att värden under 4.25 normaliseras uppåt mellan 3–3.7 och värden över 4.25 normaliseras nedåt mellan 4.8–5.5."; 

        const pulsInfo = "Pulsvärdet omvandlas till poäng mellan 0–100 där lägre puls ger högre poäng och värden över 110 ger 0.";

        const önskanAttStannaInfo =
        "Poängen baseras på patientens önskan att stanna:<br><br>" +
        "• Patienten vill stanna → Poäng: 50<br>" +
        "• Patienten vill inte stanna → Poäng: 100<br><br>" +
        "Poängen används för att justera helhetsbedömningen.";

        const andningsfrekvensInfo =
        "Andningsfrekvens bedöms utifrån patientens ålder:<br><br>" +
        "• Ålder < 10 år → Normalt: 19–24 andetag/min → Poäng: 100<br>" +
        "• Ålder 10–17 år → Normalt: 18–22 andetag/min → Poäng: 100<br>" +
        "• Ålder 18–49 år → Normalt: 16–17 andetag/min → Poäng: 100<br>" +
        "• Ålder 50–64 år → Normalt: 19–24 andetag/min → Poäng: 100<br>" +
        "• Ålder 65–79 år → Normalt: 13–27 andetag/min → Poäng: 100<br>" +
        "• Ålder ≥ 80 år → Normalt: 11–29 andetag/min → Poäng: 100<br><br>" +
        "Värden utanför intervallet ger poängen 0.";

      //Lista med beskrivning av varje parameter
      const helpTexts = 
      {
        "Hemsituation": {
          description: hemSituationInfo,
          fields: ["Hemtjänst", "Trygghetslarm", "Annan omsorg i hemmet", "Socialt nätverk"]
          },

        "Blodtryck": {
          description: BlodtryckDescription,
          fields: ["Systoliskt", "Diastoliskt"]
        },
         "Kroppstemperatur": {
          description: temperaturInfo  ,
          fields: ["Kroppstemperatur"]
        },
        "CRP (C-reaktiv protein)": {
          description: crpInfo,
          fields: ["CRP", "Föregående CRP"]
        },
          "eGFR":{
          description: "Hur parameteren räknas ut...",
          fields: ["eGPR(Krea)"]
        },
          "Glukos":{
          description: "Hur parametern räknas ut...",
          fields: ["Glukos"]
        },
          "Hemoglobin (Hb)":{
          description: "Hur parametern räknas ut...",
          fields: ["Hemoglobin (Hb)"]
        },
        "Krea":{
          description: "Hur parametern räknas ut...",
          fields: ["P-Kreatinin (enz)"]
        },
         "LPK":{
          description: "Hur parametern räknas ut...",
          fields: ["B-Leukocyter"]
        },
        "NEWS":{
          description: newsInfo,
          fields: ["Andningsfrekvens","Syremättnad","Tillförd syrgas", "Systoliskt", "Puls", "Temperatur"]
        },
        "Syremättnad":{
            description: spoInfo,
            fields: ["Syregasmättnad", "Målmättnad"]
        },
        "Kalium":{
            description: kaliumInfo,
            fields: ["Kalium"]
        },
        "Puls":{
            description: pulsInfo,
            fields: ["Puls"],
        },
         "Andningsfrekvens":{
           description: andningsfrekvensInfo,
           fields:["Andningsfrekvens", "Ålder"] 
        },
         "Natrium":
        {
           description: "Hur parametern räknas ut...",
           fields:["Natrium"] 
        },
         "TPK": {
          description: "Hur parametern räknas ut..."   ,
          fields: ["B-Trombocyter"]
        },
        "Önskar stanna": {
          description: önskanAttStannaInfo  ,
          fields: ["Önskemål vårdplats"]
        }
      };

      //////////////////////////////////////////////////////////////

      function renderParamList() {
        paramList.innerHTML = "";

        // No category selected
        if (!currentCategoryId) {
          const p = document.createElement("div");
          p.className = "empty-text";
          p.textContent = "Välj en kategori för att se eller ändra parametrar.";
          paramList.appendChild(p);
          return;
        }

        const cat = categories.find((c) => c.id === currentCategoryId);
        if (!cat) {
          const p = document.createElement("div");
          p.className = "empty-text";
          p.textContent = "Kategorin kunde inte hittas.";
          paramList.appendChild(p);
          return;
        }

        if (!cat.parameters || cat.parameters.length === 0) {
          const p = document.createElement("div");
          p.className = "empty-text";
          p.textContent = "Inga parametrar ännu för denna kategori.";
          paramList.appendChild(p);
          return;
        }

        const header = document.createElement("div");
        header.className = "param-row";
        header.style.fontWeight = "bold";
        header.innerHTML = `
          <div>Parameter</div>
          <div>Vikt (0–10)</div>
          <div>Ta bort</div>
        `;
        paramList.appendChild(header);

        cat.parameters.forEach((param) => {
          const row = document.createElement("div");
          row.className = "param-row";

          const nameLabel = document.createElement("div");
          nameLabel.className = "param-name-label";
          nameLabel.innerHTML = `
            ${param.name}
            <span class="help-btn" data-name="${param.name}">?</span>
          `;

          const sliderWrapper = document.createElement("div");
          sliderWrapper.className = "slider-wrapper";

          const slider = document.createElement("input");
          slider.type = "range";
          slider.min = "0";
          slider.max = "10";
          slider.value = param.weight;

          const sliderVal = document.createElement("span");
          sliderVal.className = "slider-value";
          sliderVal.textContent = param.weight;

          slider.oninput = () => {
            sliderVal.textContent = slider.value;
          };
          slider.onchange = async () => {
            param.weight = Number(slider.value);
            await saveCategoryToAPI(cat);
          };

          sliderWrapper.appendChild(slider);
          sliderWrapper.appendChild(sliderVal);

          const removeBtn = document.createElement("button");
          removeBtn.className = "small danger";
          removeBtn.textContent = "Ta bort";
          removeBtn.onclick = async () => {
            cat.parameters = cat.parameters.filter((p) => p.id !== param.id);
            await saveCategoryToAPI(cat);
            renderParamList();
          };

          row.appendChild(nameLabel);
          row.appendChild(sliderWrapper);
          row.appendChild(removeBtn);

          paramList.appendChild(row);

          // Aktivera hjälp-knappar
          document.querySelectorAll(".help-btn").forEach(btn => {
            btn.addEventListener("click", () => {
              const name = btn.dataset.name;

              const info = helpTexts[name] || {
                description: "Ingen information tillgänglig.",
                fields: []
              };

              const fieldsHTML = info.fields.length
                ? "<ul>" + info.fields.map(f => `<li>${f}</li>`).join("") + "</ul>"
                : "<p>Inga fält definierade.</p>";

              // Ta bort tidigare box om den finns
              document.querySelectorAll(".help-box").forEach(b => b.remove());

              // Skapa boxen
              const box = document.createElement("div");
              box.className = "help-box show";
              box.innerHTML = `
                <span class="close-btn">✖</span>
                <h2>${name}</h2>

                <h4>Vilka journalfält används?</h4>
                ${fieldsHTML}

                <h4>Beskrivning:</h4>
                <p>${info.description}</p>
              `;

              document.body.appendChild(box);

              // Stäng-knapp
              box.querySelector(".close-btn").addEventListener("click", () => {
                box.classList.remove("show");
                setTimeout(() => box.remove(), 300);
              });
            });
          });
        });
      }

      // ==============================
      //  ACTIONS
      // ==============================

      async function addParameter() {
        const cat = categories.find((c) => c.id === currentCategoryId);
        if (!cat) {
          alert("Välj en kategori först.");
          return;
        }

        const paramName = newParamSelect.value;
        if (!paramName) {
          alert("Välj en parameter från listan.");
          return;
        }

        const weight = Number(newParamWeight.value);

        const newParam = {
          id: "param_" + Date.now() + "_" + Math.floor(Math.random() * 1000),
          name: paramName,
          weight,
        };

        if (!cat.parameters) {
          cat.parameters = [];
        }
        cat.parameters.push(newParam);
        await saveCategoryToAPI(cat);

        newParamSelect.value = "";
        renderParamList();
      }

      async function deleteCurrentCategory() {
        if (!currentCategoryId) {
          alert("Välj en kategori att ta bort.");
          return;
        }

        const cat = categories.find((c) => c.id === currentCategoryId);
        if (!cat) {
          currentCategoryId = null;
          renderCategorySelect();
          return;
        }

        const confirmed = confirm(
          `Är du säker på att du vill ta bort kategorin "${cat.name}"?`,
        );
        if (!confirmed) return;

        await deleteCategoryFromAPI(cat.name);

        categories = categories.filter((c) => c.id !== currentCategoryId);
        currentCategoryId = null;
        renderCategorySelect();
      }

      // ==============================
      //  EVENT LISTENERS
      // ==============================
      addParamBtn.addEventListener("click", addParameter);
      deleteCategoryBtn.addEventListener("click", deleteCurrentCategory);

      categorySelect.addEventListener("change", () => {
        currentCategoryId = categorySelect.value || null;
        renderParamList();
      });

      newParamWeight.addEventListener("input", () => {
        newParamWeightLabel.textContent = newParamWeight.value;
      });

      // ==============================
      //  INIT
      // ==============================
      async function init() {
        categories = await loadCategoriesFromAPI();
        renderCategorySelect();
      }

      init();
    </script>
  </body>
</html>
