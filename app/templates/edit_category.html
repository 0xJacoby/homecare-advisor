<!doctype html>
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Redigera befintliga kategorier</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #f6f6f6;
        padding: 20px;
      }

      h1 {
        margin-bottom: 20px;
      }

      .back-link {
        display: inline-block;
        margin-bottom: 20px;
        padding: 8px 14px;
        border-radius: 8px;
        border: 1px solid #000;
        background: #fff;
        cursor: pointer;
        text-decoration: none;
        color: #000;
      }

      .config-container {
        background: #fff;
        border: 2px solid #000;
        border-radius: 10px;
        padding: 20px;
        max-width: 900px;
      }

      .section-title {
        font-weight: bold;
        margin-top: 10px;
        margin-bottom: 10px;
        font-size: 18px;
      }

      .row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        flex-wrap: wrap;
      }

      label {
        font-weight: bold;
        display: block;
        margin-bottom: 4px;
      }

      input[type="text"],
      select {
        padding: 6px;
        border-radius: 6px;
        border: 1px solid #aaa;
      }

      input[type="text"] {
        min-width: 240px;
        flex: 1;
      }

      select {
        min-width: 240px;
      }

      button {
        padding: 6px 12px;
        border-radius: 8px;
        border: 2px solid #000;
        background: #fff;
        cursor: pointer;
        font-weight: bold;
      }

      button.small {
        padding: 4px 8px;
        font-size: 12px;
      }

      button.danger {
        border-color: #b00020;
        color: #b00020;
      }

      button:hover {
        opacity: 0.9;
      }

      .param-list {
        margin-top: 10px;
        border-top: 1px solid #ddd;
        padding-top: 10px;
      }

      .param-row {
        display: grid;
        grid-template-columns: 1.5fr 1.5fr 0.7fr; /* 3 kolumner: namn, vikt, ta bort */
        gap: 8px;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px solid #eee;
      }

      .param-name-label {
        padding: 4px 0;
      }

      .slider-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .slider-wrapper input[type="range"] {
        flex: 1;
      }

      .slider-value {
        min-width: 24px;
        text-align: right;
        font-weight: bold;
      }

      .empty-text {
        font-style: italic;
        color: #666;
        padding: 6px 0;
      }
    </style>
  </head>
  <body>
    <!-- Back to main page -->
    <a href="/" class="back-link">← Tillbaka</a>

    <h1>Redigera befintliga kategorier</h1>

    <div class="config-container">
      <!-- ========== CATEGORY SECTION ========== -->
      <div class="section-title">1. Välj diagnoskategori</div>

      <div class="row">
        <div>
          <label for="categorySelect">Befintlig kategori:</label>
          <select id="categorySelect">
            <!-- Fylls med JS -->
          </select>
        </div>

        <div style="align-self: flex-end">
          <button id="deleteCategoryBtn" class="danger">
            Ta bort kategori
          </button>
        </div>
      </div>

      <!-- ========== PARAMETER SECTION ========== -->
      <div class="section-title">
        2. Parametrar och vikter för vald kategori
      </div>

      <!-- Add new parameter -->
      <div class="row">
        <div style="flex: 2">
          <label for="newParamSelect">Ny parameter:</label>
          <select id="newParamSelect">
            <option value="">– Välj parameter –</option>
            <option value="Blodtryck">Blodtryck</option>
            <option value="Puls">Puls</option>
            <option value="Andningsfrekvens">Andningsfrekvens</option>
            <option value="SpO₂">SpO₂ (syremättnad)</option>
            <option value="Hb">Hb</option>
            <option value="CRP">CRP</option>
            <option value="Temperatur">Temperatur</option>
            <option value="Kreatinin">Kreatinin</option>
            <option value="BMI">BMI</option>
            <option value="Ålder">Ålder</option>
          </select>
        </div>

        <div style="flex: 1">
          <label for="newParamWeight"
            >Vikt (0 = inte relevant, 10 = mycket viktig):</label
          >
          <div class="slider-wrapper">
            <input
              type="range"
              id="newParamWeight"
              min="0"
              max="10"
              value="5"
            />
            <span class="slider-value" id="newParamWeightLabel">5</span>
          </div>
        </div>

        <div style="align-self: flex-end">
          <button id="addParamBtn">Lägg till parameter</button>
        </div>
      </div>

      <!-- List of parameters for selected category -->
      <div class="param-list" id="paramList">
        <!-- Fylls med JS -->
      </div>
    </div>

    <script>
      // ==============================
      //  API CONFIG
      // ==============================
      const API_URL = window.location.origin + "/api/categories";

      // DOM elements
      const categorySelect = document.getElementById("categorySelect");
      const deleteCategoryBtn = document.getElementById("deleteCategoryBtn");
      const paramList = document.getElementById("paramList");
      const newParamSelect = document.getElementById("newParamSelect");
      const newParamWeight = document.getElementById("newParamWeight");
      const newParamWeightLabel = document.getElementById(
        "newParamWeightLabel",
      );
      const addParamBtn = document.getElementById("addParamBtn");

      // ==============================
      //  API HELPERS
      // ==============================

      // GET all categories from backend
      async function loadCategoriesFromAPI() {
        try {
          const res = await fetch(API_URL, { method: "GET" });
          if (!res.ok) {
            console.error("Could not load categories:", res.status);
            return [];
          }
          const data = await res.json();

          // Expecting: [{ name, parameters: [{name, weight, ...}, ...] }, ...]
          return (data || []).map((cat) => ({
            id: cat.name, // use name as id
            name: cat.name,
            parameters: (cat.parameters || []).map((p) => ({
              id: p.name,
              name: p.name,
              weight: Number(p.weight ?? 0) * 5, // Från 0-2 till 0-10
            })),
          }));
        } catch (err) {
          console.error("Could not load categories:", err);
          return [];
        }
      }

      // PATCH one category in backend
      async function saveCategoryToAPI(category) {
        try {
          const payload = {
            name: category.name,
            parameters: category.parameters.map((p) => ({
              name: p.name,
              weight: p.weight / 5, //Från 0-10 till 0-2
            })),
          };

          const res = await fetch(API_URL, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            console.error(
              "Could not save category:",
              res.status,
              await res.text(),
            );
          }
        } catch (err) {
          console.error("Could not save category:", err);
        }
      }

      // DELETE category by name
      async function deleteCategoryFromAPI(name) {
        try {
          const url = API_URL + "?name=" + encodeURIComponent(name);
          const res = await fetch(url, { method: "DELETE" });
          if (!res.ok) {
            console.error(
              "Could not delete category:",
              res.status,
              await res.text(),
            );
          }
        } catch (err) {
          console.error("Could not delete category:", err);
        }
      }

      // ==============================
      //  STATE
      // ==============================
      let categories = [];
      let currentCategoryId = null; // "natural mode": ingenting valt

      // ==============================
      //  UI RENDERING
      // ==============================

      function renderCategorySelect() {
        categorySelect.innerHTML = "";

        // Placeholder "natural mode"
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "– Välj kategori –";
        categorySelect.appendChild(placeholder);

        // Add all categories
        categories.forEach((cat) => {
          const opt = document.createElement("option");
          opt.value = cat.id;
          opt.textContent = cat.name;
          categorySelect.appendChild(opt);
        });

        // Keep selection if still valid
        if (
          currentCategoryId &&
          categories.find((c) => c.id === currentCategoryId)
        ) {
          categorySelect.value = currentCategoryId;
        } else {
          currentCategoryId = null;
          categorySelect.value = "";
        }

        renderParamList();
      }

      function renderParamList() {
        paramList.innerHTML = "";

        // No category selected
        if (!currentCategoryId) {
          const p = document.createElement("div");
          p.className = "empty-text";
          p.textContent = "Välj en kategori för att se eller ändra parametrar.";
          paramList.appendChild(p);
          return;
        }

        const cat = categories.find((c) => c.id === currentCategoryId);
        if (!cat) {
          const p = document.createElement("div");
          p.className = "empty-text";
          p.textContent = "Kategorin kunde inte hittas.";
          paramList.appendChild(p);
          return;
        }

        if (!cat.parameters || cat.parameters.length === 0) {
          const p = document.createElement("div");
          p.className = "empty-text";
          p.textContent = "Inga parametrar ännu för denna kategori.";
          paramList.appendChild(p);
          return;
        }

        const header = document.createElement("div");
        header.className = "param-row";
        header.style.fontWeight = "bold";
        header.innerHTML = `
          <div>Parameter</div>
          <div>Vikt (0–10)</div>
          <div>Ta bort</div>
        `;
        paramList.appendChild(header);

        cat.parameters.forEach((param) => {
          const row = document.createElement("div");
          row.className = "param-row";

          const nameLabel = document.createElement("div");
          nameLabel.className = "param-name-label";
          nameLabel.textContent = param.name;

          const sliderWrapper = document.createElement("div");
          sliderWrapper.className = "slider-wrapper";

          const slider = document.createElement("input");
          slider.type = "range";
          slider.min = "0";
          slider.max = "10";
          slider.value = param.weight;

          const sliderVal = document.createElement("span");
          sliderVal.className = "slider-value";
          sliderVal.textContent = param.weight;

          slider.oninput = () => {
            sliderVal.textContent = slider.value;
          };
          slider.onchange = async () => {
            param.weight = Number(slider.value);
            await saveCategoryToAPI(cat);
          };

          sliderWrapper.appendChild(slider);
          sliderWrapper.appendChild(sliderVal);

          const removeBtn = document.createElement("button");
          removeBtn.className = "small danger";
          removeBtn.textContent = "Ta bort";
          removeBtn.onclick = async () => {
            cat.parameters = cat.parameters.filter((p) => p.id !== param.id);
            await saveCategoryToAPI(cat);
            renderParamList();
          };

          row.appendChild(nameLabel);
          row.appendChild(sliderWrapper);
          row.appendChild(removeBtn);

          paramList.appendChild(row);
        });
      }

      // ==============================
      //  ACTIONS
      // ==============================

      async function addParameter() {
        const cat = categories.find((c) => c.id === currentCategoryId);
        if (!cat) {
          alert("Välj en kategori först.");
          return;
        }

        const paramName = newParamSelect.value;
        if (!paramName) {
          alert("Välj en parameter från listan.");
          return;
        }

        const weight = Number(newParamWeight.value);

        const newParam = {
          id: "param_" + Date.now() + "_" + Math.floor(Math.random() * 1000),
          name: paramName,
          weight,
        };

        if (!cat.parameters) {
          cat.parameters = [];
        }
        cat.parameters.push(newParam);
        await saveCategoryToAPI(cat);

        newParamSelect.value = "";
        renderParamList();
      }

      async function deleteCurrentCategory() {
        if (!currentCategoryId) {
          alert("Välj en kategori att ta bort.");
          return;
        }

        const cat = categories.find((c) => c.id === currentCategoryId);
        if (!cat) {
          currentCategoryId = null;
          renderCategorySelect();
          return;
        }

        const confirmed = confirm(
          `Är du säker på att du vill ta bort kategorin "${cat.name}"?`,
        );
        if (!confirmed) return;

        await deleteCategoryFromAPI(cat.name);

        categories = categories.filter((c) => c.id !== currentCategoryId);
        currentCategoryId = null;
        renderCategorySelect();
      }

      // ==============================
      //  EVENT LISTENERS
      // ==============================
      addParamBtn.addEventListener("click", addParameter);
      deleteCategoryBtn.addEventListener("click", deleteCurrentCategory);

      categorySelect.addEventListener("change", () => {
        currentCategoryId = categorySelect.value || null;
        renderParamList();
      });

      newParamWeight.addEventListener("input", () => {
        newParamWeightLabel.textContent = newParamWeight.value;
      });

      // ==============================
      //  INIT
      // ==============================
      async function init() {
        categories = await loadCategoriesFromAPI();

        // Optional fallback test data if API is empty:
        if (categories.length === 0) {
          categories = [
            {
              id: "cat_lung",
              name: "Lung- och andningssjukdomar",
              parameters: [
                {
                  id: "p1",
                  name: "Andningsfrekvens",
                  weight: 7,
                },
                { id: "p2", name: "SpO₂", weight: 9 },
              ],
            },
            {
              id: "cat_heart",
              name: "Hjärt- och kärlsjukdomar",
              parameters: [
                { id: "p3", name: "Blodtryck", weight: 8 },
                { id: "p4", name: "Puls", weight: 6 },
              ],
            },
            {
              id: "cat_general",
              name: "Allmän riskbedömning",
              parameters: [
                { id: "p5", name: "Ålder", weight: 5 },
                { id: "p6", name: "BMI", weight: 3 },
              ],
            },
          ];
        }

        renderCategorySelect();
      }

      init();
    </script>
  </body>
</html>
