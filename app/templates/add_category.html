<!doctype html>
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Skapa ny diagnoskategori</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #f6f6f6;
        padding: 20px;
      }
      h1 {
        margin-bottom: 20px;
      }
      .back-link {
        display: inline-block;
        margin-bottom: 20px;
        padding: 8px 14px;
        border-radius: 8px;
        border: 1px solid #000;
        background: #fff;
        cursor: pointer;
        text-decoration: none;
        color: #000;
      }
      .config-container {
        background: #fff;
        border: 2px solid #000;
        border-radius: 10px;
        padding: 20px;
        max-width: 900px;
      }
      .section-title {
        font-weight: bold;
        margin-top: 20px;
        margin-bottom: 10px;
        font-size: 18px;
      }
      .row {
        display: flex;
        gap: 20px;
        margin-bottom: 10px;
        flex-wrap: wrap;
      }
      label {
        font-weight: bold;
        display: block;
        margin-bottom: 4px;
      }
      input[type="text"],
      select {
        padding: 6px;
        border-radius: 6px;
        border: 1px solid #aaa;
        min-width: 240px;
      }
      .slider-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      button {
        padding: 6px 12px;
        border-radius: 8px;
        border: 2px solid #000;
        background: #fff;
        cursor: pointer;
        font-weight: bold;
      }
      button:hover {
        opacity: 0.9;
      }
      .param-list {
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid #ccc;
      }
      .param-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px solid #eee;
      }
      .remove-btn {
        padding: 4px 8px;
        border-radius: 6px;
        border: 2px solid #b00020;
        color: #b00020;
        background: #fff;
      }
      .bottom-create-bar {
        margin-top: 20%;
        display: flex;
        justify-content: flex-end;
      }
      #createCategoryBtn {
        padding: 14px 24px;
        font-size: 18px;
        background: #fff;
        border: 3px solid black;
        border-radius: 10px;
        cursor: pointer;
      }
      .empty-text {
        font-style: italic;
        color: #666;
      }
      .help-box {
        position: fixed;
        right: 0;
        top: 0;
        width: 400px;
        height: 60%;
        background: white;
        border: 2px solid black;
        border-radius: 10px;
        padding: 20px;
        margin: 14px;
        margin-top: 5%;
        overflow-y: auto;
        transform: translateX(100%);
        transition: 0.3s ease;
        z-index: 2000;
      }

      .help-box.show {
        transform: translateX(0);
      }

      .help-box .close-btn {
        float: right;
        cursor: pointer;
        font-weight: bold;
        font-size: 20px;
      }

      .help-btn {
        margin-left: 10px;
        background: #ddd;
        border-radius: 50%;
        width: 22px;
        height: 22px;
        display: inline-flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        border: 1px solid black;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <a href="/" class="back-link">← Tillbaka</a>
    <h1>Skapa ny diagnoskategori</h1>

    <div class="config-container">
      <!-- Kategorinamn -->
      <div class="section-title"></div>
      <div class="row">
        <div style="flex: 1">
          <label for="newCategoryName">Namn på ny kategori:</label>
          <input
            type="text"
            id="newCategoryName"
            placeholder="t.ex. Lung- och andningssjukdomar"
          />
        </div>
      </div>

      <!-- Lägg till parametrar -->
      <div class="section-title">Lägg till parametrar</div>

      <div class="row">
        <div style="flex: 2">
          <label for="newParamSelect">Ny parameter:</label>
          <select id="newParamSelect">
            <option value="">– Välj parameter –</option>
            <!-- Värdena här är de namn som backend får, texten är det användaren ser -->
            <option value="Hemsituation">Hemsituation</option>
            <option value="Blodtryck">Blodtryck</option>
            <option value="Puls">Puls</option>
            <option value="Andningsfrekvens">Andningsfrekvens</option>
            <option value="Syremättnad">Syremättnad</option>
            <option value="Hb">Hb</option>
            <option value="CRP">CRP</option>
            <option value="Kroppstempratur">Temperatur</option>
            <option value="Krea">Kreatinin</option>
            <option value="eGFR">eGFR</option>
            <option value="Glukos">Glukos</option>
            <option value="LPK">LPK</option>
            <option value="NEWS">NEWS</option>
            <option value="Kalium">Kalium</option>
            <option value="TPK">TPK</option>
            <option value="Natrium">Natrium</option>
          </select>
        </div>

        <div style="flex: 1">
          <label for="newParamWeight">Vikt (0–10):</label>
          <div class="slider-wrapper">
            <input
              type="range"
              id="newParamWeight"
              min="0"
              max="10"
              value="5"
            />
            <span id="newParamWeightLabel">5</span>
          </div>
        </div>

        <div style="align-self: flex-end">
          <button id="addParamBtn">Lägg till parameter</button>
        </div>
      </div>

      <!-- Lista med parametrar -->
      <div class="param-list" id="paramList"></div>
    </div>

    <!-- Skapa kategori-knapp -->
    <div class="bottom-create-bar">
      <button id="createCategoryBtn">✔ Skapa kategori</button>
    </div>

    
    <script>
      // API URL for categories
      const API_URL = "/api/categories/";

      const newCategoryName = document.getElementById("newCategoryName");
      const newParamSelect = document.getElementById("newParamSelect");
      const newParamWeight = document.getElementById("newParamWeight");
      const newParamWeightLabel = document.getElementById(
        "newParamWeightLabel",
      );
      const addParamBtn = document.getElementById("addParamBtn");
      const createCategoryBtn = document.getElementById("createCategoryBtn");
      const paramList = document.getElementById("paramList");

      // Temporär lista med parametrar för den nya kategorin
      // Default-parametrar: Socialt Tillstånd och NEWS med vikt 5
      let tempParameters = [
        {
          id: "param_socialt_" + Date.now(),
          name: "Hemsituation",
          weight: 5,
        },
        {
          id: "param_news_" + (Date.now() + 1),
          name: "NEWS",
          weight: 5,
        },
      ];


      /////////////// LÄGG TILL PARAMETERBESKRIVNINGAR HÄR ///////////////////////
    const hemSituationInfo = 
        "Den sociala situationen bedöms utifrån fem områden:<br><br>" +
        "• Trygghetslarm<br>" +
        "• Annan vård i hemmet<br>" +
        "• Socialt nätverk<br>" +
        "• Behov av stöd i vardagen<br>" +
        "• Personlig ADL (förmåga att klara dagliga aktiviteter)<br><br>" +
        "Varje område som fungerar bra ger 1 poäng.<br>" +
        "Poängen summeras och omvandlas till ett värde mellan 0 och 1.<br><br>" +
        "Om patienten har hemtjänst ges alltid full poäng (1.0)."

      const BlodtryckDescription =
        "Blodtryck bedöms enligt följande intervall:<br><br>" +
        "• &lt;120 / &lt;80 → Poäng: 1.0 (normalt blodtryck)<br>" +
        "• 120–129 / &lt;80 → Poäng: 0.9 (förhöjt men ej akut)<br>" +
        "• 130–139 / 80–89 → Poäng: 0.7 (lindrig hypertoni)<br>" +
        "• 140–179 / 90–119 → Poäng: 0.5 (måttlig hypertoni)<br>" +
        "• ≥180 / ≥120 → Poäng: 0.1 (kraftigt avvikande, hög risk)<br><br>" +
        "Högre poäng innebär stabilare blodtryck och mindre risk.<br>" +
        "Lägre poäng innebär högre risk och större behov av medicinsk bedömning.";

        const temperaturInfo =
        "Temperatur bedöms enligt följande:<br><br>" +
        "• 36.0–37.8°C → Poäng: 1.0 (normal kroppstemperatur)<br>" +
        "• Utanför intervallet → Poäng: 0 (avvikande temperatur)<br><br>" +
        "Ett normalt temperaturintervall ger högsta poäng och indikerar stabilt tillstånd.<br>" +
        "Avvikande temperatur kan signalera infektion eller annan påverkan och ger därför lägre poäng.";

        const crpInfo = "Räknas ut genom att jämföra föregånde CRP med nuvarande CRP. Om nuvarande CRP är mer än 10 mindre än föregående indikerar detta möjlig hemvård"; 

        const newsInfo = "NEWS beräknas genom att varje vitalparameter får 0–3 poäng, poängen summeras, och slutresultatet blir ett värde mellan 0–1 baserat på både totalpoängen och om någon parameter fått en 3:a."; 

        const spoInfo = "Syremättnaden beräknas genom att jämföra aktuell saturation med ett målvärde (ger 1 om nästan identiskt, annars 0) eller, om inget mål finns, normaliseras värdet linjärt mellan 89–100 %.";

        const kaliumInfo = "Kaliumvärdet omvandlas till en score mellan 0–1 genom att värden under 4.25 normaliseras uppåt mellan 3–3.7 och värden över 4.25 normaliseras nedåt mellan 4.8–5.5."; 

        const pulsInfo = "Pulsvärdet omvandlas till en score mellan 0–1 där lägre puls ger högre poäng och värden över 110 ger 0.";

        const önskanAttStannaInfo =
        "Poängen baseras på patientens önskan att stanna:<br><br>" +
        "• Patienten vill stanna → Poäng: 0.5<br>" +
        "• Patienten vill inte stanna → Poäng: 1.0<br><br>" +
        "Poängen används för att justera helhetsbedömningen.";

        const andningsfrekvensInfo =
        "Andningsfrekvens bedöms utifrån patientens ålder:<br><br>" +
        "• Ålder < 10 år → Normalt: 19–24 andetag/min → Poäng: 1<br>" +
        "• Ålder 10–17 år → Normalt: 18–22 andetag/min → Poäng: 1<br>" +
        "• Ålder 18–49 år → Normalt: 16–17 andetag/min → Poäng: 1<br>" +
        "• Ålder 50–64 år → Normalt: 19–24 andetag/min → Poäng: 1<br>" +
        "• Ålder 65–79 år → Normalt: 13–27 andetag/min → Poäng: 1<br>" +
        "• Ålder ≥ 80 år → Normalt: 11–29 andetag/min → Poäng: 1<br><br>" +
        "Värden utanför intervallet ger poängen 0.";

      //Lista med beskrivning av varje parameter
      const helpTexts = 
      {
        "Socialt Tillstånd": {
          description: hemSituationInfo,
          fields: ["Hemtjänst", "Trygghetslarm", "Annan vård i hemmet", "Social krets", "Behov av stöd", "Personlig ADL"]
          },

        "Blodtryck": {
          description: BlodtryckDescription,
          fields: ["Systoliskt", "Diastoliskt"]
        },
         "Temperatur": {
          description: temperaturInfo  ,
          fields: ["Temperatur"]
        },
        "CRP": {
          description: crpInfo,
          fields: ["CRP", "Föregående CRP"]
        },
          "EGFR":{
          description: "Hur parameteren räknas ut...",
          fields: ["EGFR"]
        },
          "Glukos":{
          description: "Hur parametern räknas ut...",
          fields: ["Glukos"]
        },
          "Hb":{
          description: "Hur parametern räknas ut...",
          fields: ["Hemoglobin (Hb)"]
        },
        "Kreatinin":{
          description: "Hur parametern räknas ut...",
          fields: ["Kreatinin"]
        },
         "LPK":{
          description: "Hur parametern räknas ut...",
          fields: ["LPK"]
        },
        "NEWS":{
          description: newsInfo,
          fields: ["Andningsfrekvens","Syremättnad","Tillförd syrgas", "Systoliskt", "Puls", "Temperatur"]
        },
        "Syremättnad":{
            description: spoInfo,
            fields: ["Syregasmättnad", "Målmättnad"]
        },
        "Kalium":{
            description: kaliumInfo,
            fields: ["Kalium"]
        },
        "Puls":{
            description: pulsInfo,
            fields: ["Puls"],
        },
         "Andningsfrekvens":{
           description: andningsfrekvensInfo,
           fields:["Andningsfrekvens", "Ålder"] 
        },
         "Natrium":
        {
           description: "Hur parametern räknas ut...",
           fields:["Natrium"] 
        },
         "TPK": {
          description: "Hur parametern räknas ut..."   ,
          fields: ["TPK"]
        },
        "Önskar stanna": {
          description: önskanAttStannaInfo  ,
          fields: ["Önskar stanna"]
        }
      };

      //////////////////////////////////////////////////////////////


      // Render parameter list
      function renderParamList() {
        paramList.innerHTML = "";

        if (tempParameters.length === 0) {
          paramList.innerHTML =
            "<div class='empty-text'>Inga parametrar tillagda ännu.</div>";
          return;
        }

        tempParameters.forEach((p) => {
          const row = document.createElement("div");
          row.className = "param-item";
          row.innerHTML = `
            <div>
              <strong>${p.name}</strong> – vikt: ${p.weight}
              <span class="help-btn" data-name="${p.name}">?</span>
            </div>
            <button class="remove-btn" data-id="${p.id}">Ta bort</button>
          `;
          paramList.appendChild(row);
        });

        // Ta bort-knappar
        document.querySelectorAll(".remove-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            tempParameters = tempParameters.filter(
              (p) => p.id !== btn.dataset.id,
            );
            renderParamList();
          });
        });

        // Help button — create unique box
        document.querySelectorAll(".help-btn").forEach(btn => {
          btn.addEventListener("click", () => {
            const name = btn.dataset.name;
            const description = helpTexts[name].description || "Ingen information tillgänglig.";
            const fields = helpTexts[name].fields || "Fält saknas.";

            // Remove any existing help boxes
            document.querySelectorAll(".help-box").forEach(b => b.remove());

            // Create new box
            const box = document.createElement("div");
            box.className = "help-box show";
            box.innerHTML = `
              <span class="close-btn">✖</span>
              <h2>${name}</h2>
              <h4 style="border-bottom: 1px solid black";>Vilka journalfält ingår i parametern?</h4>
              * ${fields.join("<br> * ")}
              <h4 style="border-bottom: 1px solid black;">Hur räknas parametern ut?</h4>
              <p>${description}</p>
            `;

            document.body.appendChild(box);

            // Close button
            box.querySelector(".close-btn").addEventListener("click", () => {
              box.classList.remove("show");
              setTimeout(() => box.remove(), 300);
            });
          });
        });

      }

      // Add parameter
      addParamBtn.addEventListener("click", () => {
        const name = newParamSelect.value;
        if (!name) return alert("Välj en parameter.");

        // Förhindra dubbletter (samma namn flera gånger)
        if (tempParameters.some((p) => p.name === name)) {
          return alert("Den här parametern finns redan i listan.");
        }

        tempParameters.push({
          id: "param_" + Date.now(),
          name,
          weight: Number(newParamWeight.value),
        });

        renderParamList();
      });

      // Uppdatera label vid ändring av vikt
      newParamWeight.addEventListener("input", () => {
        newParamWeightLabel.textContent = newParamWeight.value;
      });

      // Create category -> POST to API
      createCategoryBtn.addEventListener("click", async () => {
        const name = newCategoryName.value.trim();
        if (!name) return alert("Ange ett kategorinamn.");

        if (tempParameters.length === 0) {
          const proceed = confirm(
            "Inga parametrar är tillagda. Vill du skapa kategorin ändå?",
          );
          if (!proceed) return;
        }

        // Payload som backend förväntar sig
        const payload = {
          name,
          parameters: tempParameters.map((p) => ({
            name: p.name,
            // skalan från 0 till 10 blir 0 till 2
            weight: p.weight / 5.0,
          })),
        };

        try {
          const res = await fetch(API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            const text = await res.text();
            console.error("API error:", res.status, text);
            alert(
              "Kunde inte skapa kategorin. Status: " + res.status + "\n" + text,
            );
            return;
          }

          alert("Kategori skapad!");
          // Gå tillbaka till startsidan eller konfigurationssidan
          window.location.href = "/";
        } catch (err) {
          console.error("Network error creating category:", err);
          alert("Något gick fel när kategorin skulle skapas (nätverksfel?).");
        }
      });

      // Initial render med default-parametrar
      renderParamList();
    </script>
  </body>
</html>
