<!doctype html>
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Skapa ny diagnoskategori</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #f6f6f6;
        padding: 20px;
      }
      h1 {
        margin-bottom: 20px;
      }
      .back-link {
        display: inline-block;
        margin-bottom: 20px;
        padding: 8px 14px;
        border-radius: 8px;
        border: 1px solid #000;
        background: #fff;
        cursor: pointer;
        text-decoration: none;
        color: #000;
      }
      .config-container {
        background: #fff;
        border: 2px solid #000;
        border-radius: 10px;
        padding: 20px;
        max-width: 900px;
      }
      .section-title {
        font-weight: bold;
        margin-top: 20px;
        margin-bottom: 10px;
        font-size: 18px;
      }
      .row {
        display: flex;
        gap: 20px;
        margin-bottom: 10px;
        flex-wrap: wrap;
      }
      label {
        font-weight: bold;
        display: block;
        margin-bottom: 4px;
      }
      input[type="text"],
      select {
        padding: 6px;
        border-radius: 6px;
        border: 1px solid #aaa;
        min-width: 240px;
      }
      .slider-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      button {
        padding: 6px 12px;
        border-radius: 8px;
        border: 2px solid #000;
        background: #fff;
        cursor: pointer;
        font-weight: bold;
      }
      button:hover {
        opacity: 0.9;
      }
      .param-list {
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid #ccc;
      }
      .param-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px solid #eee;
      }
      .remove-btn {
        padding: 4px 8px;
        border-radius: 6px;
        border: 2px solid #b00020;
        color: #b00020;
        background: #fff;
      }
      .bottom-create-bar {
        margin-top: 30px;
        display: flex;
        justify-content: flex-end;
      }
      #createCategoryBtn {
        padding: 14px 24px;
        font-size: 18px;
        background: #fff;
        border: 3px solid black;
        border-radius: 10px;
        cursor: pointer;
      }
      .empty-text {
        font-style: italic;
        color: #666;
      }
    </style>
  </head>
  <body>
    <a href="/" class="back-link">← Tillbaka</a>
    <h1>Skapa ny diagnoskategori</h1>

    <div class="config-container">
      <!-- Kategorinamn -->
      <div class="section-title"></div>
      <div class="row">
        <div style="flex: 1">
          <label for="newCategoryName">Namn på ny kategori:</label>
          <input
            type="text"
            id="newCategoryName"
            placeholder="t.ex. Lung- och andningssjukdomar"
          />
        </div>
      </div>

      <!-- Lägg till parametrar -->
      <div class="section-title">Lägg till parametrar</div>

      <div class="row">
        <div style="flex: 2">
          <label for="newParamSelect">Ny parameter:</label>
          <select id="newParamSelect">
            <option value="">– Välj parameter –</option>
            <!-- Värdena här är de namn som backend får, texten är det användaren ser -->
            <option value="Blodtryck">Blodtryck</option>
            <option value="Puls">Puls</option>
            <option value="Andningsfrekvens">Andningsfrekvens</option>
            <option value="SpO₂">SpO₂</option>
            <option value="Hb">Hb</option>
            <option value="CRP">CRP</option>
            <option value="Temperatur">Temperatur</option>
            <option value="Kreatinin">Kreatinin</option>
            <option value="BMI">BMI</option>
            <option value="Ålder">Ålder</option>
            <!-- Default-parametrar finns också i listan så man kan lägga till dem igen -->
            <option value="Socialt Tillstånd">Socialt Tillstånd</option>
            <option value="NEWS">NEWS</option>
          </select>
        </div>

        <div style="flex: 1">
          <label for="newParamWeight">Vikt (0–10):</label>
          <div class="slider-wrapper">
            <input
              type="range"
              id="newParamWeight"
              min="0"
              max="10"
              value="5"
            />
            <span id="newParamWeightLabel">5</span>
          </div>
        </div>

        <div style="align-self: flex-end">
          <button id="addParamBtn">Lägg till parameter</button>
        </div>
      </div>

      <!-- Lista med parametrar -->
      <div class="param-list" id="paramList"></div>
    </div>

    <!-- Skapa kategori-knapp -->
    <div class="bottom-create-bar">
      <button id="createCategoryBtn">✔ Skapa kategori</button>
    </div>

    <script>
      // API URL for categories
      const API_URL = "http://127.0.0.1:5000/api/categories";

      const newCategoryName = document.getElementById("newCategoryName");
      const newParamSelect = document.getElementById("newParamSelect");
      const newParamWeight = document.getElementById("newParamWeight");
      const newParamWeightLabel =
        document.getElementById("newParamWeightLabel");
      const addParamBtn = document.getElementById("addParamBtn");
      const createCategoryBtn = document.getElementById("createCategoryBtn");
      const paramList = document.getElementById("paramList");

      // Temporär lista med parametrar för den nya kategorin
      // Default-parametrar: Socialt Tillstånd och NEWS med vikt 5
      let tempParameters = [
        {
          id: "param_socialt_" + Date.now(),
          name: "Socialt Tillstånd",
          weight: 5,
        },
        {
          id: "param_news_" + (Date.now() + 1),
          name: "NEWS",
          weight: 5,
        },
      ];

      // Render parameter list
      function renderParamList() {
        paramList.innerHTML = "";

        if (tempParameters.length === 0) {
          paramList.innerHTML =
            "<div class='empty-text'>Inga parametrar tillagda ännu.</div>";
          return;
        }

        tempParameters.forEach((p) => {
          const row = document.createElement("div");
          row.className = "param-item";
          row.innerHTML = `
            <div><strong>${p.name}</strong> – vikt: ${p.weight}</div>
            <button class="remove-btn" data-id="${p.id}">Ta bort</button>
          `;
          paramList.appendChild(row);
        });

        // Ta bort-knappar
        document.querySelectorAll(".remove-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            tempParameters = tempParameters.filter(
              (p) => p.id !== btn.dataset.id
            );
            renderParamList();
          });
        });
      }

      // Add parameter
      addParamBtn.addEventListener("click", () => {
        const name = newParamSelect.value;
        if (!name) return alert("Välj en parameter.");

        // Förhindra dubbletter (samma namn flera gånger)
        if (tempParameters.some((p) => p.name === name)) {
          return alert("Den här parametern finns redan i listan.");
        }

        tempParameters.push({
          id: "param_" + Date.now(),
          name,
          weight: Number(newParamWeight.value),
        });

        renderParamList();
      });

      // Uppdatera label vid ändring av vikt
      newParamWeight.addEventListener("input", () => {
        newParamWeightLabel.textContent = newParamWeight.value;
      });

      // Create category -> POST to API
      createCategoryBtn.addEventListener("click", async () => {
        const name = newCategoryName.value.trim();
        if (!name) return alert("Ange ett kategorinamn.");

        if (tempParameters.length === 0) {
          const proceed = confirm(
            "Inga parametrar är tillagda. Vill du skapa kategorin ändå?"
          );
          if (!proceed) return;
        }

        // Payload som backend förväntar sig
        const payload = {
          name,
          parameters: tempParameters.map((p) => ({
            name: p.name,
            // skalan från 0 till 10 blir 0 till 2
            weight: p.weight / 5,
          })),
        };

        try {
          const res = await fetch(API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            const text = await res.text();
            console.error("API error:", res.status, text);
            alert(
              "Kunde inte skapa kategorin. Status: " +
                res.status +
                "\n" +
                text
            );
            return;
          }

          alert("Kategori skapad!");
          // Gå tillbaka till startsidan eller konfigurationssidan
          window.location.href = "/";
        } catch (err) {
          console.error("Network error creating category:", err);
          alert(
            "Något gick fel när kategorin skulle skapas (nätverksfel?)."
          );
        }
      });

      // Initial render med default-parametrar
      renderParamList();
    </script>
  </body>
</html>
